<!DOCTYPE html><!--  This site was created in Webflow. https://webflow.com  --><!--  Last Published: Mon Nov 17 2025 00:32:40 GMT+0000 (Coordinated Universal Time)  -->
<html data-wf-page="690b6b0785319d44fdefb2d6" data-wf-site="68cecb820ec3dbdca3ef9099" lang="en">
<head>
  <meta charset="utf-8">
  <title>Analyze</title>
  <meta content="Analyze" property="og:title">
  <meta content="Analyze" property="twitter:title">
  <meta content="width=device-width, initial-scale=1" name="viewport">
  <meta content="Webflow" name="generator">
  <link href="../css/normalize.css" rel="stylesheet" type="text/css">
  <link href="../css/webflow.css" rel="stylesheet" type="text/css">
  <link href="../css/new-real-estate-purchase.webflow.css" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com" rel="preconnect">
  <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin="anonymous">
  <script src="https://ajax.googleapis.com/ajax/libs/webfont/1.6.26/webfont.js" type="text/javascript"></script>
  <script type="text/javascript">WebFont.load({  google: {    families: ["Montserrat:100,100italic,200,200italic,300,300italic,400,400italic,500,500italic,600,600italic,700,700italic,800,800italic,900,900italic","Droid Serif:400,400italic,700,700italic","PT Serif:400,400italic,700,700italic","Bitter:400,700,400italic","Vollkorn:400,400italic,700,700italic","Inconsolata:400,700","Varela:400","Lato:100,100italic,300,300italic,400,400italic,700,700italic,900,900italic","Great Vibes:400","Merriweather:300,300italic,400,400italic,700,700italic,900,900italic","Exo:100,100italic,200,200italic,300,300italic,400,400italic,500,500italic,600,600italic,700,700italic,800,800italic,900,900italic","DM Sans:300,regular,500,600,700","Gilda Display:regular","Barlow Condensed:regular","Barlow:300italic,regular,italic,500","Material Icons Outlined:regular","Material Icons:regular"]  }});</script>
  <script type="text/javascript">!function(o,c){var n=c.documentElement,t=" w-mod-";n.className+=t+"js",("ontouchstart"in o||o.DocumentTouch&&c instanceof DocumentTouch)&&(n.className+=t+"touch")}(window,document);</script>
  <link href="../images/favicon.svg" rel="shortcut icon" type="image/x-icon">
  <link href="../images/webclip.jpg" rel="apple-touch-icon">
</head>
<body class="body-6">
  <header class="style-two-header">
    <section>
      <div class="w-embed w-script"><!--  =========================================================
  RealtySaSS • Frosted Glass Lock (Updated to support .html)
  - Global lock for /realtysass and /realtysass.html
  - Keep ONE embed sitewide
=========================================================  -->
        <div id="rs-lock-overlay" aria-hidden="true" style="visibility:hidden; opacity:0;">
          <div class="rs-lock-centered" role="dialog" aria-labelledby="rs-lock-title" aria-modal="true">
            <div class="rs-lock-card" id="rs-lock-card">
              <h1 id="rs-lock-title">Enter Your 6-Digit Access Code</h1>
              <p class="rs-lock-sub">This page is private — please enter the unlock code we provided.</p>
              <div class="rs-code-row">
                <input id="rs-code-input" inputmode="numeric" maxlength="6" pattern="[0-9]*" autocomplete="one-time-code" aria-label="6-digit code">
                <button id="rs-code-btn" type="button">Unlock</button>
              </div>
              <p id="rs-lock-msg" class="rs-lock-msg" aria-live="polite"></p>
            </div>
          </div>
        </div>
        <style>
  :root{
    --rs-overlay-bg: rgba(6,10,18,0.55);
    --rs-accent: #8ef3c5;
    --rs-ink: #e9ecff;
    --rs-muted: #a8b0d6;
    --rs-radius: 14px;
  }
  #rs-lock-overlay{
    position:fixed; inset:0; width:100%; height:100%;
    z-index:99999; display:flex; align-items:center; justify-content:center;
    background:var(--rs-overlay-bg);
    backdrop-filter:blur(10px) saturate(120%);
    -webkit-backdrop-filter:blur(10px) saturate(120%);
    font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    transition:opacity .25s ease, visibility .25s ease;
  }
  #rs-lock-overlay.rs-hidden{ opacity:0; pointer-events:none; visibility:hidden; }
  .rs-lock-centered{ width:100%; max-width:520px; padding:20px; }
  .rs-lock-card{
    background:rgba(255,255,255,0.03);
    border-radius:var(--rs-radius);
    border:1px solid rgba(255,255,255,0.06);
    box-shadow:0 8px 30px rgba(3,6,15,0.6);
    padding:28px 24px; color:var(--rs-ink);
  }
  .rs-lock-card h1{ margin:0 0 8px; font-size:20px; font-weight:700; }
  .rs-lock-sub{ margin:0 0 18px; color:var(--rs-muted); font-size:13px; }
  .rs-code-row{ display:flex; gap:12px; }
  #rs-code-input{
    flex:1; padding:12px 14px; border-radius:10px;
    border:1px solid rgba(255,255,255,0.06);
    background:rgba(255,255,255,0.02);
    color:var(--rs-ink); font-size:16px; outline:none;
  }
  #rs-code-btn{
    padding:11px 16px; border-radius:10px; border:none;
    background:linear-gradient(180deg,var(--rs-accent),rgba(100,230,190,0.85));
    color:#02110b; font-weight:700; cursor:pointer;
  }
  .rs-lock-msg{ margin-top:12px; color:var(--rs-muted); font-size:13px; min-height:18px; }
</style>
        <script>
(function(){
  "use strict";
  // --- CONFIG ---
  const VALID_CODE = "123456";
  // Supports both /realtysass and /realtysass.html
  const USE_ALLOW_LIST = true;
  const ALLOW_PATHS = [
    /\/realtysass(?:\.html)?$/i,
  ];
  const EXEMPT_PATHS = [];
  const path = (location.pathname || "/").toLowerCase();
  const isAllowed = ALLOW_PATHS.some(re => re.test(path));
  const shouldLock = USE_ALLOW_LIST ? isAllowed : !EXEMPT_PATHS.some(re => re.test(path));
  if (!shouldLock) {
    document.querySelectorAll('#rs-lock-overlay').forEach(el => el.remove());
    return;
  }
  const overlay = document.getElementById('rs-lock-overlay');
  const input   = document.getElementById('rs-code-input');
  const btn     = document.getElementById('rs-code-btn');
  const msg     = document.getElementById('rs-lock-msg');
  overlay.classList.remove('rs-hidden');
  overlay.setAttribute('aria-hidden','false');
  overlay.style.visibility = 'visible';
  overlay.style.opacity = '1';
  const digitsOnly = s => String(s || '').replace(/\D+/g, '');
  const cleanCode  = s => digitsOnly(s).slice(0, 6);
  function showMsg(text, isError){
    msg.textContent = text || '';
    msg.style.color = isError ? '#ffb3b3' : 'var(--rs-muted)';
  }
  function unlockAllOverlays(){
    document.querySelectorAll('#rs-lock-overlay').forEach(el => {
      el.classList.add('rs-hidden');
      el.setAttribute('aria-hidden','true');
      el.style.visibility = 'hidden';
      el.style.opacity = '0';
    });
  }
  function onSubmit(){
    const entered  = cleanCode(input.value);
    const expected = cleanCode(VALID_CODE);
    if (entered.length !== 6){
      showMsg('Please enter a valid 6-digit code.', true);
      return;
    }
    if (entered === expected){
      unlockAllOverlays();
      showMsg('');
    } else {
      showMsg('That code is not valid. Try again.', true);
      const card = document.getElementById('rs-lock-card');
      if(card && card.animate){
        card.animate(
          [{transform:'translateX(-5px)'},{transform:'translateX(5px)'},{transform:'translateX(0)'}],
          {duration:260}
        );
      }
    }
  }
  if (btn) btn.addEventListener('click', onSubmit);
  if (input){
    input.addEventListener('keydown', e => { if (e.key === 'Enter') onSubmit(); });
    setTimeout(()=> input.focus(), 0);
  }
})();
</script>
      </div>
    </section>
    <div data-animation="default" data-collapse="medium" data-duration="400" data-easing="ease" data-easing2="ease" role="banner" class="navbar-logo-left-container style-three-header-container w-nav">
      <div class="container-two">
        <div class="navbar-wrapper-3">
          <div class="style-three-nav-brand">
            <a href="#" role="link" class="home-three-nav-menu-brand rezoid w-nav-brand"><img width="150" height="40" alt="" src="../images/TOR.png" loading="lazy" srcset="../images/1394a00d76ce9dd861ade690dfb1a058_TOR-p-500.png 500w, ../images/1394a00d76ce9dd861ade690dfb1a058_TOR-p-800.png 800w, ../images/1394a00d76ce9dd861ade690dfb1a058_TOR-p-1080.png 1080w, ../images/1394a00d76ce9dd861ade690dfb1a058_TOR-p-1600.png 1600w, ../images/1394a00d76ce9dd861ade690dfb1a058_TOR-p-2000.png 2000w, ../images/1394a00d76ce9dd861ade690dfb1a058_TOR-p-2600.png 2600w, ../images/TOR.png 2851w" sizes="(max-width: 479px) 88vw, 150px"></a>
          </div>
          <div class="w-layout-hflex nav-link-box">
            <div class="w-layout-hflex nav-one-button-wrap">
              <div class="menu-button-2 w-nav-button"><img width="31" height="18" alt="Hambarger Menu" src="../images/Icon-nav-1.svg" loading="lazy"></div>
            </div>
          </div>
          <a role="link" data-w-id="7d017fb5-9d8c-b442-a414-467bbc548a52" href="tel:+1800456789" class="style-three-phone-button responsive-hidden w-inline-block">
            <div class="home-three-call-button-text">
              <div class="style-three-phone-button-txt">Lets Talk</div>
              <div class="style-three-phone-button-txt">(800) 456 7890</div>
            </div>
            <div class="home-three-button-icon"><img width="46" height="46" alt="Call Icon" src="../images/Call-Icon.svg" loading="lazy" class="image-99"></div>
          </a>
          <div class="navbar-wrapper-2">
            <div class="style-three-nav-brand">
              <a href="#" role="link" class="home-three-nav-menu-brand rezoid w-nav-brand"></a>
            </div>
            <div class="w-layout-hflex nav-link-box">
              <nav role="navigation" class="nav-menu-wrapper-3 w-nav-menu">
                <ul role="list" class="nav-menu-two w-list-unstyled">
                  <li class="list-item-5 nav-five-list">
                    <div data-delay="0" data-hover="true" data-w-id="7d017fb5-9d8c-b442-a414-467bbc548a61" class="home-three-dropdaown-2 w-dropdown">
                      <div class="style-three-menu-dropdown-toggle-4 w-dropdown-toggle">
                        <div class="home-three-dropdown">
                          <a href="../index.html" class="w-inline-block">
                            <div class="home-three-dropdown-menu black-color">Home </div>
                          </a>
                        </div><img width="9" height="9" alt="Plus" src="../images/Plus.svg" loading="lazy" class="home-three-dropdown-icon">
                      </div>
                      <nav class="home-three-dropdown-list w-dropdown-list"></nav>
                    </div>
                  </li>
                  <li class="list-item-5 nav-five-list">
                    <div data-delay="0" data-hover="true" data-w-id="7d017fb5-9d8c-b442-a414-467bbc548a6a" class="home-three-dropdaown-2 w-dropdown">
                      <div class="style-three-menu-dropdown-toggle-4 w-dropdown-toggle">
                        <div class="home-three-dropdown">
                          <a href="../about-us.html" class="w-inline-block">
                            <div class="home-three-dropdown-menu black-color">ABOUT US</div>
                          </a>
                          <div class="home-three-dropdown-menu black-color">Pages</div>
                        </div><img width="9" height="9" alt="Plus" src="../images/Plus.svg" loading="lazy" class="home-three-dropdown-icon">
                      </div>
                      <nav class="home-three-dropdown-list w-dropdown-list">
                        <div class="home-three-dropdown-block">
                          <a href="#" role="link" class="home-three-dropdown-link-2 w-dropdown-link">Who We Are</a>
                          <a href="#" role="link" class="home-three-dropdown-link-2 w-dropdown-link">Our Realtors</a>
                        </div>
                      </nav>
                    </div>
                  </li>
                  <li class="list-item-5 nav-five-list">
                    <div data-delay="0" data-hover="true" data-w-id="7d017fb5-9d8c-b442-a414-467bbc548a7a" class="home-three-dropdaown-2 w-dropdown">
                      <div class="style-three-menu-dropdown-toggle-4 w-dropdown-toggle">
                        <div class="home-three-dropdown">
                          <a href="../realtysass.html" class="w-inline-block">
                            <div class="home-three-dropdown-menu black-color">Realty SaSS</div>
                          </a>
                          <div class="home-three-dropdown-menu black-color">Properties</div>
                        </div><img width="9" height="9" alt="Plus" src="../images/Plus.svg" loading="lazy" class="home-three-dropdown-icon">
                      </div>
                      <nav class="home-three-dropdown-list w-dropdown-list">
                        <div class="home-three-dropdown-block">
                          <a href="../features/financial-dashboard.html" role="link" class="home-three-dropdown-link-2 w-dropdown-link">KPI Dashboard</a>
                          <a href="../features/re-defined.html" role="link" class="home-three-dropdown-link-2 w-dropdown-link">RE-Defined</a>
                          <a href="../features/zipped.html" role="link" class="home-three-dropdown-link-2 w-dropdown-link">ZiPPED</a>
                          <a href="../features/psychology.html" role="link" class="home-three-dropdown-link-2 w-dropdown-link">Psychology Insight</a>
                          <a href="#" role="link" class="home-three-dropdown-link-2 w-dropdown-link">Ask-Elena</a>
                        </div>
                      </nav>
                    </div>
                  </li>
                  <li class="list-item-5 nav-five-list">
                    <div data-delay="0" data-hover="true" data-w-id="7d017fb5-9d8c-b442-a414-467bbc548a90" class="home-three-dropdaown-2 w-dropdown">
                      <div class="style-three-menu-dropdown-toggle-4 w-dropdown-toggle">
                        <div class="home-three-dropdown">
                          <a href="#" class="w-inline-block">
                            <div class="home-three-dropdown-menu black-color">Blogs &amp; More</div>
                          </a>
                          <div class="home-three-dropdown-menu black-color">Blog</div>
                        </div><img width="9" height="9" alt="Plus" src="../images/Plus.svg" loading="lazy" class="home-three-dropdown-icon">
                        <a href="#" role="button" data-w-id="7d017fb5-9d8c-b442-a414-467bbc548a99" class="hero-button-3 nav-button w-inline-block">
                          <div class="button-mask">
                            <div class="link-text-wrp">
                              <div class="text-block-24">Contact us</div>
                              <div class="secondt-btn-text">Contact us</div>
                            </div>
                          </div>
                        </a>
                      </div>
                      <nav class="home-three-dropdown-list w-dropdown-list">
                        <div class="home-three-dropdown-block">
                          <a href="../blog-page/va-loans.html" role="link" class="home-three-dropdown-link-2 w-dropdown-link">VA Loan</a>
                          <a href="../blog-page/a-i-influence-in-realty.html" role="link" class="home-three-dropdown-link-2 w-dropdown-link">Realtor Killer?</a>
                          <a href="../blog-page/realtors.html" role="link" class="home-three-dropdown-link-2 w-dropdown-link">Do I Need a Realtor?</a>
                          <a href="../features/beat-the-realtor.html" role="link" class="home-three-dropdown-link-2 w-dropdown-link">Beat the Realtor (Game)</a>
                        </div>
                      </nav>
                    </div>
                  </li>
                </ul>
              </nav>
              <div class="w-layout-hflex nav-one-button-wrap">
                <div class="menu-button-2 w-nav-button"><img width="31" height="18" alt="Hambarger Menu" src="../images/Icon-nav-1.svg" loading="lazy"></div>
              </div>
            </div>
            <a role="link" data-w-id="7d017fb5-9d8c-b442-a414-467bbc548aad" href="tel:+1800456789" class="style-three-phone-button responsive-hidden w-inline-block">
              <div class="home-three-call-button-text">
                <div class="style-three-phone-button-txt">Lets Talk</div>
                <div class="style-three-phone-button-txt">(800) 456 7890</div>
              </div>
              <div class="home-three-button-icon"><img width="46" height="46" alt="Call Icon" src="../images/Call-Icon.svg" loading="lazy" class="image-100"></div>
            </a>
          </div>
        </div>
      </div>
    </div>
  </header>
  <section class="section-169">
    <div class="code-embed-17 w-embed w-script">
      <!DOCTYPE html>
      <!--  =========================================================
Fiduciary Snapshot — v3.9.2
- Fullscreen, luxury cards, deep shadows
- Pie shows 4 slices:
     Expenses / Mortgage / Savings Target / Disposable Income
- Text color for headers/subheaders = #bdb5b5
- KPI strip shows $ and Credit Score w/ band
- Grade chip shows Letter / Disposable, plus bar meter
- Bar chart Monthly/Yearly toggle
- Rent vs Buy projection
- Debug logs added to updateExpenseBars() so we can see all months
SaSS™ = Naughty Realty, Serious Returns.
=========================================================  -->
      <section id="fid-fullscreen-shell" style="all: initial;">
        <!--  //#1 Chart.js CDN (must load BEFORE our script so charts work)  -->
        <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
        <!--  //#2 CORE STYLES  -->
        <style>
    /* Global reset just for this widget */
    #fid-fullscreen-shell,
    #fid-fullscreen-shell * {
      box-sizing: border-box;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    /* Full-screen dark environment */
    #fid-fullscreen-shell {
      width: 100vw;
      max-width: 100vw;
      overflow-x: auto;
      background: #0b0b12; /* rich near-black */
      color: #fff;
      padding-top: 24px;
      padding-bottom: 64px;
    }
    /* Inner shell resists Webflow squeezing */
    #fid-snapshot-shell {
      width: 100%;
      max-width: 100vw;
      min-width: 1024px; /* keep desktop dashboard layout */
      margin: 0;
      padding: 0 24px 0 24px;
    }
    :root{
      --bg:#0f1220;
      --panel:#15192b;
      --card:#181b2e;
      --ink:#fff;
      --subink:#bdb5b5; /* UPDATED per user request */
      --accent:#6aa7ff;
      --accent2:#8ef3c5;
      --ok:#55d399;
      --warn:#f9c74f;
      --bad:#ff6b6b;
    }
    /* Main dashboard card */
    #fid-card {
      background: var(--card);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 18px;
      box-shadow: 0 10px 24px rgba(0,0,0,.35);
      padding: 18px;
      position: relative;
      color: var(--ink);
      width: 100%;
    }
    /* Header row: grade chip + export */
    .fid-row {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 16px;
      align-items: flex-start;
    }
    @media (max-width:840px){
      .fid-row {
        grid-template-columns: 1fr;
      }
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.08);
      background:#0f1326;
      white-space:nowrap;
      color:var(--ink);
      font-size:13px;
      line-height:1.2;
    }
    .dot{
      width:12px;
      height:12px;
      border-radius:50%;
    }
    .mini-wrap{
      display:flex;
      align-items:center;
      gap:10px;
      color:var(--ink);
    }
    .mini-wrap b{
      color:var(--ink);
    }
    .mini-wrap span{
      color:var(--subink); /* now #bdb5b5 */
    }
    .mini-meter{
      width:160px;
      height:8px;
      border-radius:999px;
      background:#0b0f23;
      border:1px solid rgba(255,255,255,.12);
      overflow:hidden;
    }
    .mini-meter > div{
      height:100%;
      width:0%;
      background:linear-gradient(90deg,var(--accent2),#f9c74f,#ff6b6b);
    }
    .export{
      padding:10px 14px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background:#0f1326;
      color:var(--ink);
      cursor:pointer;
      font-size:13px;
      line-height:1.2;
    }
    .export:hover{ filter:brightness(1.15); }
    /* KPI strip (5 cards) */
    .kpi-strip{
      display:grid;
      grid-template-columns:repeat(5,minmax(0,1fr));
      gap:18px;
      margin-top:18px;
    }
    @media (max-width:1280px){
      .kpi-strip{ grid-template-columns:repeat(3,minmax(0,1fr)); }
    }
    @media (max-width:760px){
      .kpi-strip{ grid-template-columns:repeat(2,minmax(0,1fr)); }
    }
    @media (max-width:520px){
      .kpi-strip{ grid-template-columns:1fr; }
    }
    .kpi-card{
      background:#12162b;
      border:1px solid rgba(255,255,255,.06);
      border-radius:14px;
      padding:14px;
      min-height:76px;
      color:var(--ink);
      box-shadow:0 16px 32px rgba(0,0,0,.6);
    }
    .kpi-title{
      font-size:12px;
      color:var(--subink);           /* #bdb5b5 for titles */
      letter-spacing:.2px;
      text-transform:uppercase;
      font-weight:600;
    }
    .kpi-val{
      margin-top:8px;
      font-weight:700;
      font-size:20px;
      display:flex;
      align-items:center;
      gap:8px;
      color:#bdb5b5;
      line-height:1.2;
    }
    .delta{
      font-size:11px;
      margin-left:8px;
      padding:2px 6px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(85,211,153,.10);
      color:var(--ok);
      line-height:1.2;
    }
    /* Credit score gauge bar in KPI card */
    .score-bar{
      position:relative;
      width:100%;
      height:10px;
      border-radius:999px;
      background:linear-gradient(90deg,#ff6b6b,#f9c74f,#55d399);
      margin-top:8px;
    }
    .score-marker{
      position:absolute;
      top:-3px;
      width:2px;
      height:16px;
      background:#fff;
      border-radius:2px;
      left:0%;
      box-shadow:0 0 6px rgba(255,255,255,.6);
    }
    /* Middle grid (Pie left, Bar right) */
    .mid{
      display:grid;
      grid-template-columns:480px 1fr;
      gap:18px;
      margin-top:18px;
      align-items:stretch;
    }
    @media (max-width:1080px){
      .mid{ grid-template-columns:1fr; }
    }
    .card-mini{
      background:#12162b;
      border:1px solid rgba(255,255,255,.06);
      border-radius:16px;
      padding:16px;
      display:flex;
      flex-direction:column;
      color:var(--ink);
      box-shadow:0 16px 32px rgba(0,0,0,.6);
    }
    .card-mini h3{
      margin:0 0 12px;
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      flex-wrap:wrap;
    }
    .card-mini h3 span:first-child{
      font-size:14px;
      color:var(--subink);         /* #bdb5b5 */
      font-weight:700;
      letter-spacing:.3px;
      text-transform:uppercase;
    }
    .card-mini h3 span:last-child{
      font-size:11px;
      font-weight:400;
      text-transform:none;
      color:var(--subink);         /* #bdb5b5 */
      line-height:1.4;
      letter-spacing:0;
    }
    .chart-holder{
      position:relative;
      height: clamp(220px, 36vh, 420px);
      width:100%;
      display:block;
      overflow:hidden;
      border-radius:12px;
      background:#0f1220;
      border:1px solid rgba(255,255,255,.05);
      box-shadow:0 24px 48px rgba(0,0,0,.8) inset;
    }
    /* Make pie chart area taller */
    .card-mini:first-child .chart-holder{
      height: clamp(280px, 42vh, 460px);
    }
    canvas{
      width:100% !important;
      height:100% !important;
      display:block;
    }
    .ring-center{
      position:absolute;
      inset:0;
      display:grid;
      place-items:center;
      pointer-events:none;
      font-weight:800;
      font-size:28px;
      color:#fff;
      text-shadow:0 0 18px rgba(0,0,0,.5);
    }
    .legend{
      display:flex;
      gap:16px;
      margin-top:10px;
      flex-wrap:wrap;
      color:var(--subink); /* #bdb5b5 */
      font-size:12px;
    }
    .l-pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .l-dot{
      width:10px;
      height:10px;
      border-radius:999px;
      background:#6aa7ff;
      box-shadow:0 0 8px rgba(106,167,255,.6);
    }
    /* Controls above bar chart */
    .controls{
      display:flex;
      gap:10px;
      align-items:center;
      margin:4px 0 10px;
      flex-wrap:wrap;
    }
    .select{
      background:#0f1326;
      color:#fff;
      border:1px solid rgba(255,255,255,.10);
      border-radius:10px;
      padding:8px 10px;
      font-size:12px;
    }
    .toggle{
      cursor:pointer;
      padding:6px 10px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.10);
      background:#0f1326;
      font-size:12px;
      color:#fff;
      line-height:1.2;
    }
    .toggle[aria-pressed="true"]{
      background:#192041;
      border-color:rgba(255,255,255,.22);
    }
    /* Bottom "Rent vs Buy" block */
    .bottom{
      background:#12162b;
      border:1px solid rgba(255,255,255,.06);
      border-radius:16px;
      padding:16px;
      margin-top:18px;
      color:var(--ink);
      box-shadow:0 16px 32px rgba(0,0,0,.6);
    }
    .row-slim{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:8px;
      flex-wrap:wrap;
    }
    .h4{
      font-weight:800;
      letter-spacing:.2px;
      color:var(--subink); /* #bdb5b5 */
      font-size:14px;
      text-transform:uppercase;
    }
    /* Rent selector capsule */
    .rent-ctrl{
      display:flex;
      align-items:center;
      gap:10px;
      margin-left:auto;
      flex-wrap:wrap;
    }
    .rent-label{
      font-size:11px;
      color:var(--subink); /* #bdb5b5 */
      line-height:1.2;
      text-transform:uppercase;
      letter-spacing:.3px;
    }
    .rent-select{
      appearance:none;
      background:#0f1326;
      color:#fff;
      border:1px solid rgba(255,255,255,.12);
      border-radius:10px;
      padding:8px 10px;
      min-width:140px;
      cursor:pointer;
      font-size:12px;
      line-height:1.2;
    }
    .muted{
      color:var(--subink); /* #bdb5b5 */
      font-size:12px;
      line-height:1.4;
    }
    @media print{
      body, html{ background:#fff !important; }
    }
  </style>
        <!--  //#3 DASHBOARD BODY  -->
        <div id="fid-snapshot" data-summarize="https://theorozcorealty.netlify.app/.netlify/functions/summarize" style="all: initial;">
          <!--  Google Font  -->
          <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
          <div id="fid-snapshot-shell">
            <div id="fid-card">
              <!--  //#3.1 HEADER ROW  -->
              <div class="fid-row">
                <span class="badge" id="grade-chip">
                  <span id="fid-dot" class="dot" style="background:#888"></span>
                  <div class="mini-wrap">
                    <div>
                      <b id="fid-grade">Loading...</b>
                      <span id="fid-disp" style="margin-left:8px;">$0</span>
                    </div>
                    <div class="mini-meter" aria-label="grade-meter">
                      <div id="fid-meter"></div>
                    </div>
                  </div>
                </span>
                <button id="fid-export" class="export">Export ▾</button>
              </div>
              <!--  //#3.2 KPI STRIP  -->
              <div class="kpi-strip">
                <div class="kpi-card">
                  <div class="kpi-title">Total Monthly Income</div>
                  <div class="kpi-val">
                    <span id="k-income">$0</span>
                    <span class="delta" id="k-inc-delta">+0%</span>
                  </div>
                </div>
                <div class="kpi-card">
                  <div class="kpi-title">Total Monthly Expense</div>
                  <div class="kpi-val">
                    <span id="k-expense">$0</span>
                    <span class="delta" id="k-exp-delta" style="background:rgba(255,107,107,.12); color:var(--bad);">+0%</span>
                  </div>
                </div>
                <div class="kpi-card">
                  <div class="kpi-title">Mortgage Estimate</div>
                  <div class="kpi-val" id="k-mtg">$0</div>
                </div>
                <div class="kpi-card">
                  <div class="kpi-title">Total Savings</div>
                  <div class="kpi-val">
                    <span id="k-save">$0</span>
                    <span class="delta" id="k-sav-delta">+1.3%</span>
                  </div>
                </div>
                <div class="kpi-card">
                  <div class="kpi-title">
                    Credit Score <span id="score-band" style="margin-left:6px; font-weight:700;"></span>
                  </div>
                  <div class="kpi-val"><span id="k-score">—</span></div>
                  <div class="score-bar">
                    <div id="score-marker" class="score-marker"></div>
                  </div>
                </div>
              </div>
              <!--  //#3.3 MID GRID  -->
              <div class="mid">
                <!--  PIE SIDE  -->
                <div class="card-mini">
                  <h3>
                    <span>OVERALL BUDGET</span>
                    <span>Expenses vs Mortgage vs Savings Target vs Leftover</span>
                  </h3>
                  <div class="chart-holder">
                    <canvas id="fid-pie"></canvas>
                    <div class="ring-center" id="pie-center">0</div>
                  </div>
                  <div class="legend">
                    <span class="l-pill">
                      <span class="l-dot" style="background:#6aa7ff;box-shadow:0 0 8px rgba(106,167,255,.6);"></span>
                      Expenses
                    </span>
                    <span class="l-pill">
                      <span class="l-dot" style="background:#55d399;box-shadow:0 0 8px rgba(85,211,153,.6);"></span>
                      Mortgage
                    </span>
                    <span class="l-pill">
                      <span class="l-dot" style="background:#8ef3c5;box-shadow:0 0 8px rgba(142,243,197,.6);"></span>
                      Savings Target
                    </span>
                    <span class="l-pill">
                      <span class="l-dot" style="background:#f9c74f;box-shadow:0 0 8px rgba(249,199,79,.6);"></span>
                      Disposable Income
                    </span>
                  </div>
                </div>
                <!--  BAR SIDE  -->
                <div class="card-mini">
                  <h3>
                    <span>MONTHLY EXPENSES INTELLIGENCE</span>
                    <span>This month by category / last months by trend</span>
                  </h3>
                  <div class="controls">
                    <button id="mode-abs" class="toggle" aria-pressed="true">$ Totals</button>
                    <button id="mode-pct" class="toggle" aria-pressed="false">% Composition</button>
                    <select id="exp-view" class="select">
                      <option value="monthly" selected="">Monthly</option>
                      <option value="yearly">Yearly</option>
                    </select>
                  </div>
                  <div class="chart-holder">
                    <canvas id="fid-bars"></canvas>
                  </div>
                  <div class="muted" style="margin-top:8px">
                    Monthly view shows categories for the active budget month.
                    Yearly view shows each saved month on the x-axis, stacked by category.
                    Toggle $ / % to switch measure.
                  </div>
                </div>
              </div>
              <!--  //#3.4 RENT VS BUY  -->
              <div class="bottom">
                <div class="row-slim">
                  <div class="h4">RENT vs BUY — NET COST</div>
                  <div class="rent-ctrl">
                    <!--  Rent select for 10-year comparison  -->
                    <span class="badge" title="Starting monthly rent used for the 10-year comparison" style="gap:8px;">
                      <span class="rent-label">Rent Price (mo)</span>
                      <select id="rent-select" class="rent-select"></select>
                    </span>
                    <span class="badge" title="Years until Net Cost of Buying ≤ Renting" style="margin-left:6px;">
                      <div style="display:flex; flex-direction:column; line-height:1.1;">
                        <span style="font-size:11px; color:var(--subink)">Break-even (Years)</span>
                        <b id="be-yrs" style="font-size:16px;">—</b>
                      </div>
                    </span>
                  </div>
                </div>
                <div class="chart-holder" style="height: clamp(240px, 36vh, 400px);">
                  <canvas id="fid-line"></canvas>
                </div>
              </div>
              <div class="muted" style="margin-top:10px">
                Outputs are educational, not advice.
              </div>
            </div>
          </div>
        </div>
        <!--  //#4 CORE LOGIC  -->
        <script>
  (()=> {
    if (window.__FIDUCIARY_WIDGET_MOUNTED__) return;
    window.__FIDUCIARY_WIDGET_MOUNTED__ = true;
    /* //#4.1 Utilities / helpers ------------------------------------ */
    const $=(q)=>document.querySelector(q);
    const cur=(n,d=0)=> (Number(n)||0).toLocaleString('en-US',{
      style:'currency',
      currency:'USD',
      minimumFractionDigits:d,
      maximumFractionDigits:d
    });
    const signed=(n)=> (n>=0? cur(n,0) : ('-'+cur(Math.abs(n),0)));
    // Standard mortgage payment formula
    function pmti(P,r,n){
      if(r===0) return P/n;
      const x=Math.pow(1+r,n);
      return P*(r*x)/(x-1);
    }
    // APR estimate from credit score (rough bands)
    function scoreAPR(s){
      s=Number(s)||720;
      if(s>=780) return 6.50;
      if(s>=760) return 6.75;
      if(s>=720) return 7.00;
      if(s>=700) return 7.20;
      if(s>=680) return 7.35;
      if(s>=660) return 7.85;
      if(s>=640) return 8.25;
      if(s>=620) return 9.25;
      return 9.95;
    }
    function bandFromScore(s){
      if(s>=760) return 'Excellent';
      if(s>=720) return 'Good';
      if(s>=680) return 'Fair';
      if(s>=640) return 'OK-ish';
      if(s>=620) return 'Weak';
      return 'Subprime';
    }
    // helper: current month key like "2025-11"
    function currentMonthKey(){
      const now = new Date();
      return now.getFullYear() + '-' + String(now.getMonth()+1).padStart(2,'0');
    }
    // helper: nice short label like "Nov"
    function monthLabelFromKey(key){
      const [y,m]=String(key).split('-');
      const idx = Number(m)-1;
      const short = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][idx]||key;
      return short;
    }
    let pieChart=null, barChart=null, lineChart=null;
    let barMode='abs';      // "$ Totals" vs "% Composition" (visual placeholder)
    let barView='monthly';  // "monthly" (categories) vs "yearly" (timeline)
    let rentStartOverride = null; // user-chosen rent override
    /* //#4.2 Bridge intake & fallback data --------------------------- */
    let bridge = null;
    try {
      const raw = localStorage.getItem('realtysass.bridge');
      if (raw) bridge = JSON.parse(raw);
    } catch(e){}
    // Try URL hash fallback (embedded usage)
    if (!bridge && location.hash){
      const m = location.hash.match(/(?:^|#|&)rsb=([A-Za-z0-9\-_]+)/);
      if (m){
        try{
          const json = decodeURIComponent(
            escape(
              atob(m[1].replace(/-/g,'+').replace(/_/g,'/'))
            )
          );
          bridge = JSON.parse(json);
        }catch(e){}
      }
    }
    // Try legacy expense rows fallback (no monthKey info)
    try{
      if(!bridge?.itemizedRows){
        const rows = JSON.parse(localStorage.getItem('va.expenses.rows')||'[]');
        if(rows?.length){
          bridge = Object.assign({}, bridge, {
            itemizedRows: rows.map(r=>({
              name:r.name,
              monthly:r.month,
              cat:r.cat
              // legacy rows don't store which month they belong to
            }))
          });
        }
      }
    }catch(_){}
    // Listen for postMessage updates (iframe/parent comms)
    window.addEventListener('message', (ev)=>{
      try{
        const msg = ev.data || {};
        if (msg.type==='realtysass-bridge' && msg.payload){
          bridge=msg.payload;
          rentStartOverride=null;
          paintAll();
        }
      }catch(e){}
    }, false);
    /* //#4.3 Snapshot from bridge (income/expenses/etc.) ------------- */
    function snapshotFromBridge(){
      const b = bridge || {};
      const income   = Number(b.income)||0;
      const expenses = Number(b.expenses)||0;
      const savings  = Number(b.savings)||0; // actual $ saved now
      // Desired savings % (slider). If missing, assume 5%.
      const savingsRatePct = Number(b.savingsRatePct) || 5;
      const savingsTargetAmount = (income * (savingsRatePct/100));
      let housing = Number(b.housing)||0;
      let pAndI   = Number(b.pAndI)||0;
      const price = Number(b.price)||0;
      const dpPct = Number(b.dpPct)||0;
      const dpAmt = Number(b.dpAmt) || (price * (dpPct/100));
      const apr   = Number(b.apr)|| scoreAPR(Number(b.creditScore)||720);
      const termY = Number(b.termYears)||30;
      const tihoa = Number(b.tihoa)||0;
      const pmi   = Number(b.pmi)||0;
      // Rebuild mortgage P&I if not provided
      if (!housing){
        const loan  = Math.max(0, price - dpAmt);
        const mRate = (apr/100)/12;
        const termN = Math.max(1, termY*12);
        pAndI = loan>0 ? pmti(loan, mRate, termN) : 0;
        housing = pAndI + tihoa + pmi;
      }
      // freePost considers planned savings target
      const freePost = income - expenses - housing - savingsTargetAmount;
      return {
        income,
        expenses,
        savings, // tracked for KPI
        housing,
        freePost,
        price,
        dpPct,
        dpAmt,
        apr,
        creditScore:Number(b.creditScore)||720,
        termYears:termY,
        tihoa,
        pmi,
        pAndI,
        savingsRatePct,
        savingsTargetAmount
      };
    }
    /* //#4.4 Expense bucketing logic -------------------------------- */
    const bucketDefs = {
      Housing: /(rent|mortgage|pmi|hoa|home ?insur|property tax|tihoa|home repair|furniture)/i,
      Utilities: /(util|electric|power|water|gas|sewer|trash|phone|internet|wifi)/i,
      Transportation: /(car|auto|fuel|gasoline|uber|lyft|transport|parking|toll|insurance.*auto|maintenance)/i,
      Food: /(grocery|grocer|food|meal|dining|restaurant|lunch|breakfast|coffee)/i,
      Health: /(health|medical|dental|vision|pharmacy|rx|gym)/i,
      Entertainment: /(netflix|hulu|prime|disney|movie|game|sport|concert|entertain)/i
    };
    const bucketOrder = [
      'Housing','Utilities','Transportation','Food','Health','Entertainment','Other'
    ];
    // put one row amount into the right bucket
    function distributeToBucket(monthObj, nameLower, amt){
      let bucket = 'Other';
      for (const [b,rx] of Object.entries(bucketDefs)){
        if (rx.test(nameLower)) {
          bucket = b;
          break;
        }
      }
      monthObj[bucket] = (monthObj[bucket]||0) + Math.max(0, amt);
    }
    /**
     * //#4.4.1 monthlyBucketsFromBridge()
     *
     * Goal:
     * - Build per-month totals for each category.
     * - Guarantee at least ONE usable month so charts never die.
     */
    function monthlyBucketsFromBridge(){
      const rows = Array.isArray(bridge?.itemizedRows) ? bridge.itemizedRows : [];
      const perMonthBucketTotals = {}; // {monthKey:{bucket:amount}}
      // walk rows and drop each into a month bucket
      rows.forEach(r=>{
        // try to guess the row's month key
        let mk = r.monthKey || r.dateKey || r.month || null;
        // normalize mk to YYYY-MM
        if(mk && typeof mk === 'string'){
          const m = mk.match(/^(20\d{2})[-/](\d{1,2})/);
          if(m){
            const yyyy = m[1];
            const mm   = String(m[2]).padStart(2,'0');
            mk = `${yyyy}-${mm}`;
          }else{
            mk = null;
          }
        } else {
          mk = null;
        }
        if(!mk){
          mk = currentMonthKey();
        }
        if(!perMonthBucketTotals[mk]){
          perMonthBucketTotals[mk] = Object.fromEntries(bucketOrder.map(b=>[b,0]));
        }
        const name = String(r.name||r.item||'').toLowerCase();
        const amt  = Number(r.amount||r.monthly||r.value||0)||0;
        distributeToBucket(perMonthBucketTotals[mk], name, amt);
      });
      // If we STILL have no months at all (no rows?), synthesize 1 month
      if(Object.keys(perMonthBucketTotals).length===0){
        const mk = currentMonthKey();
        perMonthBucketTotals[mk] = Object.fromEntries(bucketOrder.map(b=>[b,0]));
        // fallback split: take bridge.expenses and spread across buckets
        const ex = Number(bridge?.expenses)||0;
        const alloc = {
          Housing:.35, Utilities:.12, Transportation:.14,
          Food:.20, Health:.07, Entertainment:.07, Other:.05
        };
        for(const k of bucketOrder){
          perMonthBucketTotals[mk][k] += ex * (alloc[k]||0);
        }
      }
      // sort keys oldest -> newest
      const monthKeys = Object.keys(perMonthBucketTotals).sort();
      const labels = monthKeys.map(k=> monthLabelFromKey(k));
      const latestMonthKey = monthKeys[monthKeys.length-1];
      return {
        monthKeys,
        labels,
        perMonthBucketTotals,
        latestMonthKey
      };
    }
    /* //#4.5 Grade calculation (financial health score) ------------- */
    function localGrade(s){
      // use desired savings target in the pressure calc
      const totalShare = (s.expenses + s.housing + s.savingsTargetAmount) / (s.income||1);
      const housingShare = s.housing / (s.income||1);
      let g=92;
      if(totalShare>=0.85) g-=30; else if(totalShare>=0.70) g-=15; else g+=4;
      if(housingShare>0.40) g-=18; else if(housingShare>0.33) g-=8; else g+=4;
      if(s.freePost<0) g-=30;
      else if((s.freePost/s.income)<0.10) g-=10;
      else if((s.freePost/s.income)>=0.20) g+=4;
      const sr = s.savingsTargetAmount/(s.income||1);
      if(sr<0.10) g-=8;
      else if(sr>=0.20) g+=4;
      g=Math.max(0,Math.min(100,g));
      const letter =
        g>=98?'A+': g>=92?'A': g>=88?'A-'
      : g>=82?'B+': g>=76?'B': g>=72?'B-'
      : g>=66?'C+': g>=60?'C': g>=55?'C-'
      : g>=50?'D+': g>=45?'D':'F';
      return {letter, totalShare};
    }
    /* //#4.6 Chart initialization ----------------------------------- */
    function initCharts(){
      const pieCtx = document.getElementById('fid-pie').getContext('2d');
      pieChart = new Chart(pieCtx,{
        type:'doughnut',
        data:{
          // 4-slice model:
          // Expenses, Mortgage, Savings Target, Disposable Income
          labels:['Expenses','Mortgage','Savings Target','Disposable Income'],
          datasets:[{
            data:[0,0,0,1],
            backgroundColor:[
              '#6aa7ff',   // Expenses (blue)
              '#55d399',   // Mortgage (green)
              '#8ef3c5',   // Savings Target (mint)
              '#f9c74f'    // Disposable Income (gold)
            ],
            borderWidth:0
          }]
        },
        options:{
          cutout:'66%',
          plugins:{ legend:{ display:false } },
          responsive:true,
          maintainAspectRatio:false
        }
      });
      const barCtx = document.getElementById('fid-bars').getContext('2d');
      barChart = new Chart(barCtx,{
        type:'bar',
        data:{ labels: [], datasets: [] },
        options:{
          plugins:{
            legend:{
              labels:{ color:'#fff', boxWidth:12 },
              display:true
            }
          },
          scales:{
            x:{
              stacked:true,
              ticks:{ color:'#fff' },
              grid:{ color:'rgba(255,255,255,.06)' }
            },
            y:{
              stacked:true,
              ticks:{ color:'#fff' },
              grid:{ color:'rgba(255,255,255,.06)' }
            }
          },
          responsive:true,
          maintainAspectRatio:false,
          datasets:{ bar:{ borderWidth:0, borderRadius:6 } }
        }
      });
      const lineCtx = document.getElementById('fid-line').getContext('2d');
      lineChart = new Chart(lineCtx,{
        type:'line',
        data:{
          labels:[],
          datasets:[
            {
              label:'Buy – Net Cost',
              data:[],
              tension:.35,
              fill:false,
              borderWidth:2,
              pointRadius:0,
              borderColor:'#6aa7ff'
            },
            {
              label:'Rent – Net Cost',
              data:[],
              tension:.35,
              fill:false,
              borderWidth:2,
              pointRadius:0,
              borderColor:'#55d399'
            }
          ]
        },
        options:{
          plugins:{
            legend:{
              display:true,
              labels:{ color:'#fff' }
            },
            tooltip:{
              callbacks:{
                label:(c)=>{
                  const lbl = `${c.dataset.label}: ${cur(c.raw,0)}`;
                  if (c.datasetIndex===0 && lineChart.__equityByYear){
                    const eq = lineChart.__equityByYear[c.dataIndex]||0;
                    return [lbl, `Equity: ${cur(eq,0)}`];
                  }
                  if (c.datasetIndex===1 && lineChart.__cumRentByYear){
                    const cr = lineChart.__cumRentByYear[c.dataIndex]||0;
                    return [lbl, `Cumulative Rent: ${cur(cr,0)}`];
                  }
                  return lbl;
                }
              }
            }
          },
          scales:{
            x:{
              ticks:{ color:'#fff' },
              grid:{ display:false }
            },
            y:{
              ticks:{ color:'#fff' },
              grid:{ color:'rgba(255,255,255,.06)' }
            }
          },
          responsive:true,
          maintainAspectRatio:false
        }
      });
      // Keep charts responsive if container resizes
      const ro = new ResizeObserver(()=>{
        pieChart?.resize();
        barChart?.resize();
        lineChart?.resize();
      });
      document.querySelectorAll('#fid-fullscreen-shell .chart-holder').forEach(h=> ro.observe(h));
    }
    /* //#4.7 Update expense bar chart (MONTHLY vs YEARLY) ----------- */
    function updateExpenseBars(){
      /* DEBUG LOGS so we can inspect what data you actually have */
      console.log("DEBUG_bridge", bridge);
      console.log("DEBUG_itemizedRows", bridge?.itemizedRows);
      console.log("DEBUG_localStorage_allKeys", Object.keys(localStorage));
      const {
        monthKeys,
        labels,
        perMonthBucketTotals,
        latestMonthKey
      } = monthlyBucketsFromBridge();
      // shared color palette by bucket
      const palette = [
        '#6aa7ff', // Housing
        '#8ab6ff', // Utilities
        '#55d399', // Transportation
        '#8ef3c5', // Food
        '#f9c74f', // Health
        '#b58cff', // Entertainment
        '#6e7a94'  // Other
      ];
      if(barView === 'yearly'){
        // YEARLY MODE
        barChart.data.labels = labels; // ["Nov","Dec","Jan",...]
        barChart.data.datasets = bucketOrder.map((bucketName, idx)=>({
          label: bucketName,
          data: monthKeys.map(mk=> (perMonthBucketTotals[mk]?.[bucketName] || 0)),
          backgroundColor: palette[idx % palette.length],
          stack:'y'
        }));
      } else {
        // MONTHLY MODE
        const latestTotals = perMonthBucketTotals[latestMonthKey] || {};
        barChart.data.labels = bucketOrder;
        barChart.data.datasets = [{
          label:'This Month',
          data: bucketOrder.map(b=> latestTotals[b]||0),
          backgroundColor: bucketOrder.map((_,idx)=> palette[idx % palette.length]),
          stack:'m'
        }];
      }
      // barMode ($ vs %) toggle hook left in place for future
      barChart.update();
    }
    /* //#4.8 Rent vs Buy — 10-year model ----------------------------- */
    const CLOSE_PCT = 0.03;  // 3% closing costs
    const SELL_PCT  = 0.07;  // 7% selling cost
    const APP_Y     = 0.03;  // 3%/yr appreciation
    const INVRET_Y  = 0.05;  // 5%/yr invested alt return
    const MAINT_Y   = 0.01;  // 1%/yr maintenance
    function buildRentVsBuySeries10Y_FD(s, rentStartMonthly){
      const Y = 10;
      const N = Y*12;
      const labels = Array.from({length:Y+1}, (_,i)=> `Year ${i}`);
      const price = Math.max(150000, Number(s.price)||350000);
      const down  = Math.max(0, Number(s.dpAmt)||0);
      const loan0 = Math.max(0, price - down);
      const r_m   = (Number(s.apr)||7)/100/12;
      const nTot  = (Number(s.termYears)||30)*12;
      const piMo  = loan0>0 ? pmti(loan0, r_m, nTot) : 0;
      const tihoa = Number(s.tihoa)||0;
      const pmi   = Number(s.pmi)||0;
      const maintMo = (price*MAINT_Y)/12;
      // upfront cost to buy
      const closing = price*CLOSE_PCT;
      const upfront = down + closing;
      // rent baseline (1% rule-ish, then inflates 3%/yr)
      const rent0     = Math.max(0, Number(rentStartMonthly));
      const rent_g_m  = Math.pow(1+0.03, 1/12)-1;
      // appreciation monthly
      const appr_m    = Math.pow(1+APP_Y, 1/12)-1;
      // alt investment monthly
      const inv_m     = Math.pow(1+INVRET_Y, 1/12)-1;
      let bal = loan0, homeVal = price;
      let cumRent = 0, cumOwner = upfront;
      const rentSeries=[0], buySeries=[upfront], equityByYear=[down], cumRentByYear=[0];
      let altInvest = down;
      let beMonth = null; // first month where buy ≤ rent net
      for(let m=1; m<=N; m++){
        // --- RENT path
        const rent_m = rent0 * Math.pow(1+rent_g_m, m-1);
        cumRent += rent_m;
        altInvest *= (1 + inv_m);
        // --- BUY path
        const interest = bal * r_m;
        const principal = Math.max(0, piMo - interest);
        bal = Math.max(0, bal - principal);
        cumOwner += (piMo + tihoa + pmi + maintMo);
        // Assets (house value grows, equity builds)
        homeVal *= (1 + appr_m);
        const equity = Math.max(0, homeVal - bal);
        // Compute net position at month m
        const sellCost_m = homeVal * SELL_PCT;
        const netIfSold_m = Math.max(homeVal - sellCost_m - bal, 0);
        const buyNet_m  = Math.max(0, cumOwner - netIfSold_m);
        const rentNet_m = Math.max(0, cumRent - (altInvest - down));
        if (beMonth===null && buyNet_m <= rentNet_m){
          beMonth = m;
        }
        // Record each year (12 mo)
        if (m % 12 === 0){
          buySeries.push(buyNet_m);
          rentSeries.push(rentNet_m);
          equityByYear.push(equity);
          cumRentByYear.push(cumRent);
        }
      }
      const beYears = beMonth!==null ? (beMonth/12) : null;
      return {
        labels,
        rentSeries,
        buySeries,
        equityByYear,
        cumRentByYear,
        beYears
      };
    }
    function currentRentStartFromBridge(s){
      // Default base rent ~1% of price
      const base = Math.max(0, (Number(s.price)||350000) * 0.01);
      return rentStartOverride==null
        ? base
        : Math.max(0, rentStartOverride);
    }
    function populateRentSelect(base){
      const sel = document.getElementById('rent-select');
      const vals = [];
      for(let d=-6; d<=6; d++){
        const v = Math.max(0, Math.round((base + d*500)));
        if(!vals.includes(v)) vals.push(v);
      }
      sel.innerHTML = vals.map(v=> (
        `<option value="${v}">${cur(v,0)}</option>`
      )).join('');
      const target = Math.max(0, Math.round(currentRentStartFromBridge(snapshotFromBridge())));
      if (!vals.includes(target)){
        sel.insertAdjacentHTML('afterbegin',
          `<option value="${target}">${cur(target,0)}</option>`
        );
      }
      sel.value = String(target);
    }
    /* //#4.9 Paint everything on screen ------------------------------ */
    function paintAll(){
      const s = snapshotFromBridge();
      // --- KPIs
      $('#k-income').textContent  = cur(s.income,0);
      $('#k-expense').textContent = cur(s.expenses,0);
      $('#k-mtg').textContent     = cur(s.housing,0);
      $('#k-save').textContent    = cur(s.savings,0);
      // Credit score KPI + band + gauge marker
      const cs = Number(s.creditScore)||720;
      $('#k-score').textContent = cs;
      $('#score-band').textContent = `(${bandFromScore(cs)})`;
      const pct = Math.max(0, Math.min(1, (cs - 300) / (850 - 300)));
      $('#score-marker').style.left = (pct*100)+'%';
      // Grade chip + meter width + color
      // We'll report disposable AFTER planned savings target
      const postPlanDisposable = s.income - s.expenses - s.housing - s.savingsTargetAmount;
      $('#fid-disp').textContent = signed(postPlanDisposable);
      const {letter, totalShare} = localGrade({
        ...s,
        totalShare:(s.expenses + s.housing + s.savingsTargetAmount)/(s.income||1)
      });
      $('#fid-grade').textContent = letter+' / Disposable';
      $('#fid-dot').style.background =
        (letter[0]==='A'||letter[0]==='B')
          ? 'var(--ok)'
          : (letter[0]==='C'
              ? 'var(--warn)'
              : 'var(--bad)');
      $('#fid-meter').style.width =
        (Math.max(0, Math.min(1, totalShare))*100)+'%';
      // --- Initialize charts if needed
      if(!pieChart || !barChart || !lineChart) initCharts();
      // PIE chart (Expenses, Mortgage, Savings Target, Disposable Income)
      $('#pie-center').textContent = s.income>0
        ? s.income.toLocaleString()
        : '0';
      const disposableAfterPlan = Math.max(
        0,
        s.income - s.expenses - s.housing - s.savingsTargetAmount
      );
      pieChart.data.datasets[0].data = [
        s.expenses,
        s.housing,
        s.savingsTargetAmount,
        disposableAfterPlan
      ];
      pieChart.update();
      // BAR chart
      updateExpenseBars();
      // Rent select options (1% rule around price)
      const baseRent = Math.max(
        0,
        (Number(s.price)||350000) * 0.01
      );
      populateRentSelect(baseRent);
      // RENT vs BUY projection using full FD math
      const rentStart = currentRentStartFromBridge(s);
      const rvb = buildRentVsBuySeries10Y_FD(s, rentStart);
      lineChart.data.labels = rvb.labels;
      lineChart.data.datasets[0].data = rvb.buySeries;
      lineChart.data.datasets[1].data = rvb.rentSeries;
      lineChart.__equityByYear   = rvb.equityByYear;
      lineChart.__cumRentByYear  = rvb.cumRentByYear;
      lineChart.update();
      // Break-even display
      const be = rvb.beYears;
      $('#be-yrs').textContent =
        (be==null)
          ? '—'
          : ((Math.round(be*10)/10)
              .toFixed(1)+' yrs')
              .replace('.0 yrs',' yrs');
    }
    /* //#4.10 Event handlers (rent change, toggles, export) ---------- */
    // Rent dropdown changes the model live
    document.addEventListener('change', (e)=>{
      if (e.target && e.target.id==='rent-select'){
        rentStartOverride = Number(e.target.value)||0;
        paintAll();
      }
    });
    // $ Totals vs % Composition buttons
    document.getElementById('mode-abs').addEventListener('click', ()=>{
      barMode='abs';
      document.getElementById('mode-abs').setAttribute('aria-pressed','true');
      document.getElementById('mode-pct').setAttribute('aria-pressed','false');
      updateExpenseBars();
    });
    document.getElementById('mode-pct').addEventListener('click', ()=>{
      barMode='pct';
      document.getElementById('mode-pct').setAttribute('aria-pressed','true');
      document.getElementById('mode-abs').setAttribute('aria-pressed','false');
      updateExpenseBars();
    });
    // Monthly vs Yearly dropdown
    $('#exp-view').addEventListener('change', (e)=>{
      barView = e.target.value === 'monthly' ? 'monthly' : 'yearly';
      updateExpenseBars();
    });
    // Export button → PNG snapshot
    $('#fid-export').addEventListener('click', async ()=>{
      const el = document.getElementById('fid-card');
      const rect = el.getBoundingClientRect();
      const scale = Math.max(2, window.devicePixelRatio || 2);
      const cloned = el.cloneNode(true);
      const serializer = new XMLSerializer();
      const markup = serializer.serializeToString(cloned);
      const svg = '<svg xmlns="http://www.w3.org/2000/svg" width="'+(rect.width*scale)+'" height="'+(rect.height*scale)+'">' +
                    '<foreignObject x="0" y="0" width="100%" height="100%">' +
                      markup +
                    '</foreignObject>' +
                  '</svg>';
      const blob = new Blob([svg], {type: 'image/svg+xml;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const img = new Image();
      img.onload = ()=>{
        const canvas = document.createElement('canvas');
        canvas.width = rect.width*scale;
        canvas.height = rect.height*scale;
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = '#0f1220';
        ctx.fillRect(0,0,canvas.width,canvas.height);
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        URL.revokeObjectURL(url);
        const a = document.createElement('a');
        a.download = 'Fiduciary-Snapshot.png';
        a.href = canvas.toDataURL('image/png');
        a.click();
      };
      img.src = url;
    });
    /* //#4.11 Boot --------------------------------------------------- */
    (function boot(){
      initCharts();
      paintAll();
    })();
  })();
  </script>
      </section>
    </div>
  </section>
  <section>
    <div class="w-embed w-script"><!--  Fiduciary Memo — v1.4 (Rank + Last Name guaranteed)  -->
      <div id="fid-memo" data-summarize="https://theorozcorealty.netlify.app/.netlify/functions/summarize" style="all: initial;">
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
        <style>
    #fid-memo, #fid-memo *{ box-sizing:border-box; font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    :root{ --ink:#1b1f2b; --muted:#4b5568; --brand:#0f1220; --border:rgba(0,0,0,.10); }
    /* Card */
    #fid-memo .memo-card{
      background:#ffffff; color:var(--ink);
      border:1px solid var(--border); border-radius:14px;
      padding:0; margin:18px auto; width:100%; max-width:900px;
      box-shadow:0 10px 24px rgba(0,0,0,.25);
    }
    #fid-memo .memo-page{ padding:28px 28px 22px; }
    #fid-memo .memo-head{ text-align:center; margin-bottom:8px; }
    #fid-memo .memo-head img{ height:64px; width:auto; display:block; margin:6px auto 10px auto; }
    #fid-memo .memo-title{ font-weight:900; letter-spacing:.2px; font-size:18px; text-transform:uppercase; }
    #fid-memo .memo-sub{ color:var(--muted); font-size:12px; }
    #fid-memo .memo-hr{ border:none; border-top:1px solid var(--border); margin:12px 0 14px; }
    #fid-memo .memo-body p{ margin:10px 0; line-height:1.65; font-size:14px; }
    #fid-memo .memo-body strong{ font-weight:800; }
    #fid-memo .memo-meta{ display:flex; justify-content:space-between; gap:8px; color:var(--muted); font-size:12px; margin-bottom:2px; }
    #fid-memo .memo-sign{ margin-top:14px; border-top:1px dashed rgba(0,0,0,.18); padding-top:10px; font-size:13px; }
    /* Status note */
    #fid-memo .ai-note{ margin:10px 28px 18px; font-size:11px; }
    #fid-memo .ai-note.loading{ color:#334155; }
    #fid-memo .ai-note.success{ color:#177245; }
    #fid-memo .ai-note.error{ color:#b42318; }
    /* Toolbar */
    #fid-memo .toolbar{
      max-width:900px; margin:0 auto 10px; display:flex; gap:8px; justify-content:flex-end;
      font-size:13px;
    }
    #fid-memo .btn{
      padding:8px 12px; border-radius:10px; border:1px solid rgba(0,0,0,.12); background:#f8fafc; color:#0f172a; cursor:pointer;
    }
    #fid-memo .btn:hover{ filter:brightness(0.98); }
    @media print{
      #fid-memo .memo-card{ box-shadow:none; border-color:#bbb; }
      body, html{ background:#fff !important; }
      #fid-memo .toolbar{ display:none; }
    }
  </style>
        <div class="toolbar">
          <button id="memo-refresh" class="btn">Regenerate Memo</button>
          <button id="memo-print" class="btn">Print / Save PDF</button>
        </div>
        <div class="memo-card" id="memo">
          <div class="memo-page">
            <div class="memo-head">
              <img src="../images/Call-to-Action.png" alt="Orozco Crest">
              <div class="memo-title">FIDUCIARY MEMO</div>
              <div class="memo-sub">Board-Ready Summary</div>
            </div>
            <div class="memo-meta">
              <span id="memo-date"></span>
              <span id="memo-client">Client:</span>
              <span>Prepared by: The Orozco Realty</span>
            </div>
            <hr class="memo-hr">
            <div id="memo-body" class="memo-body">
              <p><em>Generating executive memo…</em></p>
            </div>
            <div class="memo-sign">— <strong>Elena</strong>, Your Virtual Concierge<br><span style="opacity:.85">The Orozco Realty</span></div>
          </div>
          <div id="memo-note" class="ai-note loading">Preparing AI memo…</div>
        </div>
        <script>
  (()=> {
    if (window.__FIDUCIARY_MEMO_MOUNTED__) return;
    window.__FIDUCIARY_MEMO_MOUNTED__ = true;
    /* ---------- small utils ---------- */
    const $=(q)=>document.querySelector(q);
    const cur=(n,d=0)=> (Number(n)||0).toLocaleString('en-US',{style:'currency',currency:'USD',minimumFractionDigits:d,maximumFractionDigits:d});
    function pmti(P,r,n){ if(r===0) return P/n; const x=Math.pow(1+r,n); return P*(r*x)/(x-1); }
    function scoreAPR(s){ s=Number(s)||720;
      if(s>=780) return 6.50; if(s>=760) return 6.75; if(s>=720) return 7.00; if(s>=700) return 7.20;
      if(s>=680) return 7.35; if(s>=660) return 7.85; if(s>=640) return 8.25; if(s>=620) return 9.25; return 9.95;
    }
    function gradeLocal(s){
      let g=92;
      if(s.totalShare>=0.85) g-=30; else if(s.totalShare>=0.70) g-=15; else g+=4;
      if(s.housingShare>0.40) g-=18; else if(s.housingShare>0.33) g-=8; else g+=4;
      if(s.freePost<0) g-=30; else if((s.freePost/s.income)<0.10) g-=10; else if((s.freePost/s.income)>=0.20) g+=4;
      const sr=s.savings/(s.income||1); if(sr<0.10) g-=8; else if(sr>=0.20) g+=4;
      g=Math.max(0,Math.min(100,g));
      const letter = g>=98?'A+': g>=92?'A': g>=88?'A-'
                   : g>=82?'B+': g>=76?'B': g>=72?'B-'
                   : g>=66?'C+': g>=60?'C': g>=55?'C-'
                   : g>=50?'D+': g>=45?'D':'F';
      return {g,letter};
    }
    const lastNameOf=(full)=> String(full||'').trim().split(/\s+/).slice(-1)[0]||'Client';
    /* ---------- identity helpers ---------- */
    function getStoredJSON(key){
      try{ const raw = localStorage.getItem(key); return raw? JSON.parse(raw): null; }catch(_){ return null; }
    }
    function extractIdentity(b){
      // Preferred: identity explicitly sent via bridge (see dashboard addition below)
      const bi = b?.identity || {};
      const profFromBridge = b?.profile || {};
      const profFromLocal  = getStoredJSON('realtysass.profile') || {};
      // Compose a name if we only have lastName
      const first = bi.firstName || profFromLocal.firstName || '';
      const last  = bi.lastName  || profFromLocal.lastName  || lastNameOf(profFromLocal.name||'');
      const name  = [first,last].filter(Boolean).join(' ') || profFromLocal.name || 'Client';
      return {
        name,
        email: bi.email || profFromLocal.email || '',
        branch: bi.branch || profFromLocal.branch || '',
        paygrade: bi.paygrade || '',
        rankTitle: bi.rankTitle || '',  // e.g., "Major"
        mode: bi.mode || ''             // AD or VET (optional)
      };
    }
    /* ---------- friendly fallbacks if only paygrade is available ---------- */
    function rankFromPaygrade(pg){
      const MAP = {"O-1":"Second Lieutenant","O-2":"First Lieutenant","O-3":"Captain","O-4":"Major","O-5":"Lieutenant Colonel","O-6":"Colonel",
                   "O-7":"Brigadier General","O-8":"Major General","O-9":"Lieutenant General","O-10":"General",
                   "W-1":"Warrant Officer 1","W-2":"Chief Warrant Officer 2","W-3":"Chief Warrant Officer 3","W-4":"Chief Warrant Officer 4","W-5":"Chief Warrant Officer 5",
                   "E-1":"Airman Basic / Private","E-2":"Airman / Private","E-3":"A1C / PFC","E-4":"Senior Airman / Specialist","E-5":"Staff Sergeant / Sergeant","E-6":"Technical Sergeant / Staff Sergeant",
                   "E-7":"Master Sergeant / SFC","E-8":"Senior Master Sergeant / 1st Sgt","E-9":"Chief Master Sergeant / Sgt Major"};
      const p = String(pg||'').toUpperCase().replace(/\s+/g,'');
      return MAP[p] || '';
    }
    /* ---------- bridge ---------- */
    const getSummarizeURL=()=> (document.getElementById('fid-memo')?.dataset?.summarize||'').trim();
    let bridge = null;
    try { const raw = localStorage.getItem('realtysass.bridge'); if (raw) bridge = JSON.parse(raw); } catch(e){}
    if (!bridge && location.hash){
      const m = location.hash.match(/(?:^|#|&)rsb=([A-Za-z0-9\-_]+)/);
      if (m){ try{ const json = decodeURIComponent(escape(atob(m[1].replace(/-/g,'+').replace(/_/g,'/')))); bridge = JSON.parse(json);}catch(e){} }
    }
    window.addEventListener('message', (ev)=>{
      try{ const msg = ev.data || {}; if (msg.type==='realtysass-bridge' && msg.payload){ bridge=msg.payload; paint(); } }catch(e){}
    }, false);
    /* ---------- snapshot ---------- */
    function pmSnapshot(b){
      const income   = Number(b?.income)||0;
      const expenses = Number(b?.expenses)||0;
      const savings  = Number(b?.savings)||0;
      let housing    = Number(b?.housing)||0;
      let pAndI      = Number(b?.pAndI)||0;
      const price = Number(b?.price)||0;
      const dpPct = Number(b?.dpPct)||0;
      const dpAmt = Number(b?.dpAmt) || (price * (dpPct/100));
      const apr   = Number(b?.apr)|| scoreAPR(Number(b?.creditScore)||720);
      const termY = Number(b?.termYears)||30;
      const tihoa = Number(b?.tihoa)||0;
      const pmi   = Number(b?.pmi)||0;
      if (!housing){
        const loan  = Math.max(0, price - dpAmt);
        const mRate = (apr/100)/12;
        const termN = Math.max(1, termY*12);
        pAndI = loan>0 ? pmti(loan, mRate, termN) : 0;
        housing = pAndI + tihoa + pmi;
      }
      const freePost = income - expenses - savings - housing;
      return {
        income, expenses, savings, housing, freePost,
        price, dpPct, dpAmt, apr, creditScore:Number(b?.creditScore)||720, termYears:termY,
        tihoa, pmi, pAndI,
        totalShare: income>0 ? (expenses+savings+housing)/income : 1,
        housingShare: income>0 ? housing/income : 1,
        dti: income>0 ? ((expenses+housing)/income) : 1,
        coverage: expenses>0 ? income/expenses : (income>0?Infinity:0),
        runwayMonths: expenses>0 ? (savings/expenses) : 0,
        profile: b?.profile || {},
        military: b?.military || {}
      };
    }
    function bucketsFromBridge(){
      try{
        const rows = Array.isArray(bridge?.itemizedRows) ? bridge.itemizedRows : JSON.parse(localStorage.getItem('va.expenses.rows')||'[]');
        if (!rows?.length) return {};
        const sums = {};
        rows.forEach(r=>{
          const k = String(r.cat||'Other');
          const v = Number(r.amount||r.monthly||r.month||0) || 0;
          sums[k] = (sums[k]||0) + v;
        });
        return sums;
      }catch(_){ return {}; }
    }
    /* ---------- local synthesis ---------- */
    function synthesizeFiveFromSnapshot(s, who){
      const last = who.name ? (who.name.trim().split(/\s+/).slice(-1)[0]) : 'Client';
      const rankNice = who.rankTitle || rankFromPaygrade(who.paygrade) || 'Service Member';
      const houPct = s.income>0 ? (s.housing/s.income)*100 : 0;
      const dtiPct = s.income>0 ? ((s.expenses+s.housing)/s.income)*100 : 0;
      const {letter} = gradeLocal(s);
      const cov = (s.coverage===Infinity)?'∞':(s.coverage||0).toFixed(2)+'×';
      const runway = (s.runwayMonths||0).toFixed(2);
      const laneMin = s.income*0.28, laneMax = s.income*0.33;
      const autoSave = Math.max(50, Math.round(s.income*0.10));
      const discShift = Math.round(s.income*0.10);
      const p1 = `<p><strong>${rankNice} ${last}</strong>, thank you for your service. This executive memo provides a precise, plain-English readout of your financial health, key risks, and the steps to correct them. With income <strong>${cur(s.income,0)}</strong>, expenses <strong>${cur(s.expenses,0)}</strong>, programmed savings <strong>${cur(s.savings,0)}</strong>, housing <strong>${cur(s.housing,0)}</strong> (~${houPct.toFixed(0)}%), DTI ~<strong>${dtiPct.toFixed(0)}%</strong>, coverage <strong>${cov}</strong>, and runway ~<strong>${runway} months</strong>, your current grade reads <strong>${letter}</strong>.</p>`;
      const p2 = `<p><strong>Financial Health—Concrete Targets.</strong> Keep housing in the <strong>28–33%</strong> lane: today that equals <strong>${cur(laneMin,0)}–${cur(laneMax,0)}</strong> per month all-in (P&I + taxes/insurance/HOA/PMI). Disposable income must stay positive; aim for <strong>≥10%</strong> of income left over. Set an automatic transfer of <strong>${cur(autoSave,0)}</strong> on payday to build a <strong>3–6 month</strong> reserve. If a mortgage quote pushes housing above ${cur(laneMax,0)} or DTI beyond <strong>43%</strong>, lower price or increase down payment before locking.</p>`;
      const p3 = `<p><strong>Biggest Issues Observed.</strong> The grade is most sensitive to high DTI and a thin runway. Credit score tiers directly move APR and payment; each tier can swing monthly cost by <strong>$75–$200+</strong>. If discretionary categories exceed <strong>10–12%</strong> of income, they suppress savings velocity and raise risk.</p>`;
      const p4 = `<p><strong>Improvement Playbook (Do This Next).</strong> 1) Pull free reports at <a href="https://www.annualcreditreport.com" target="_blank" rel="noopener">annualcreditreport.com</a>; dispute errors and drive utilization under <strong>30%</strong> (ideal <strong>&lt;10%</strong>). 2) Reallocate ~<strong>${cur(discShift,0)}</strong>/mo from discretionary to your autopay reserve until you reach <strong>3–6 months</strong>. 3) Keep total commitments ≤ <strong>70%</strong> of income; sequence debt by highest payment/lowest term (DTI relief). 4) When offering on a home, size to <strong>${cur(laneMin,0)}–${cur(laneMax,0)}</strong> all-in and negotiate seller credits; compare points vs lender credits. See <a href="https://www.consumerfinance.gov/" target="_blank" rel="noopener">cfpb.gov</a>.</p>`;
      const p5 = `<p><strong>Closing & Next Steps.</strong> We’ll convert these numbers into a pre-approval brief, then run property scenarios inside the housing lane, sequencing COE → underwriting → lock strategy → curated inventory. I will refresh this memo as your live numbers improve so you purchase with confidence.</p>`;
      return [p1,p2,p3,p4,p5].join('');
    }
    function enforceFive(html, fallbackHTML){
      const d=document.createElement('div'); d.innerHTML=html||'';
      let paras = Array.from(d.querySelectorAll('p')).map(p=>p.innerHTML.trim()).filter(Boolean);
      if (paras.length < 5 && fallbackHTML){
        const d2=document.createElement('div'); d2.innerHTML=fallbackHTML;
        paras = Array.from(d2.querySelectorAll('p')).map(p=>p.innerHTML.trim()).filter(Boolean);
      }
      while (paras.length < 5) paras.push('');
      if (paras.length > 5) paras = paras.slice(0,5);
      return paras.map(t=>`<p>${t}</p>`).join('');
    }
    async function fetchAIMemo(snapshot, totals, who){
      const url = getSummarizeURL();
      if (!url) return { error:'No summarize URL set' };
      const styleGuide = {
        persona: { name:"Elena, Virtual Concierge",
          role:"Executive Finance & Real Estate Strategist (CEO voice)",
          pedigree:"Harvard-trained, VA-loan specialist, boardroom communicator",
          voice:["Crisp, confident, data-forward","Plain English with banker precision","No slang, no emojis, no fluff"],
          audience: who.name || "Client"
        },
        purpose: "Five-paragraph CEO-grade memo: purpose, dollar targets, issues, playbook with links, closing.",
        structure: [
          "P1 – Rank + Last Name greeting; purpose and headline figures.",
          "P2 – Concrete targets: housing 28–33% lane in dollars; DI ≥10%; autopay reserve $ and 3–6 mo; DTI guardrails.",
          "P3 – Biggest issues tied to live numbers (credit tier $ impact; runway; discretionary %).",
          "P4 – Improvement playbook with links (utilization ladder; dispute flow; debt sequence; seller credits/points).",
          "P5 – Closing + next steps."
        ],
        formatting: { paragraphs:5, bullets:"none", boldKeyNumbers:true, currency:"USD, whole dollars", readingLevel:"executive" }
      };
      try{
        const res = await fetch(url, { method:'POST', headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ kind:'fiduciary-memo', snapshot, buckets: totals, identity: who, styleGuide }) });
        if(!res.ok) throw new Error('HTTP '+res.status);
        return await res.json();
      }catch(e){ return { error:String(e.message||e) }; }
    }
    function setNote(state, text){
      const note=$('#memo-note');
      note.classList.remove('loading','error','success');
      note.classList.add(state);
      note.textContent = text;
    }
    function paint(){
      const s = pmSnapshot(bridge || {});
      const who = extractIdentity(bridge || {});
      const displayName = who.rankTitle
        ? `${who.rankTitle} ${ (who.name||'').trim().split(/\s+/).slice(-1)[0] || 'Client' }`
        : (who.name || 'Client');
      $('#memo-client').textContent = `Client: ${displayName}${who.email? ' • '+who.email : ''}`;
      try{ $('#memo-date').textContent = new Date().toLocaleDateString(undefined,{year:'numeric',month:'long',day:'numeric'});}catch(_){}
      const totals = bucketsFromBridge();
      const localFive = synthesizeFiveFromSnapshot(s, who);
      $('#memo-body').innerHTML = localFive;
      setNote('loading','Preparing AI memo…');
      (async ()=>{
        const ai = await fetchAIMemo(s, totals, who);
        if (ai?.memoHtml){
          const html = enforceFive(ai.memoHtml, localFive);
          $('#memo-body').innerHTML = html;
          setNote('success','AI memo generated via Netlify (OpenAI).');
        } else if (ai?.memo){
          const html = enforceFive(`<p>${String(ai.memo)}</p>`, localFive);
          $('#memo-body').innerHTML = html;
          setNote('success','AI memo generated via Netlify (OpenAI).');
        } else {
          $('#memo-body').innerHTML = localFive;
          setNote('error', `AI memo failed (${ai?.error||'unknown reason'}). Showing local executive analysis.`);
        }
      })();
    }
    $('#memo-refresh').addEventListener('click', paint);
    $('#memo-print').addEventListener('click', ()=> window.print());
    paint();
  })();
  </script>
      </div>
    </div>
  </section>
  <script src="https://d3e54v103j8qbb.cloudfront.net/js/jquery-3.5.1.min.dc5e7f18c8.js?site=68cecb820ec3dbdca3ef9099" type="text/javascript" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
  <script src="../js/webflow.js" type="text/javascript"></script>
</body>
</html>